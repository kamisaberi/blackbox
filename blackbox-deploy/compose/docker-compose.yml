version: '3.8'

services:
  # -------------------------------------------------------
  # 1. The Engine (C++)
  # -------------------------------------------------------
  core:
    build: 
      context: ../../blackbox-core
      dockerfile: docker/Dockerfile
    image: blackbox-core:latest
    container_name: blackbox-core
    restart: always
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_NICE
    ports:
      - "514:514/udp"
      - "601:601/tcp"
      - "2055:2055/udp" # NetFlow
      - "8081:8081"
    environment:
      - BLACKBOX_UDP_PORT=514
      - BLACKBOX_CLICKHOUSE_URL=http://clickhouse:8123
      - BLACKBOX_REDIS_HOST=redis
    depends_on:
      - clickhouse
      - redis
    volumes:
      - ../../data/models:/app/models
      - ../../data/config:/app/config
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # -------------------------------------------------------
  # 2. The Control Tower (Go API)
  # -------------------------------------------------------
  tower:
    build: ../../blackbox-tower
    image: blackbox-tower:latest
    container_name: blackbox-tower
    restart: always
    ports:
      - "8080:8080"
    environment:
      - TOWER_PORT=8080
      - BLACKBOX_CLICKHOUSE_URL=tcp://clickhouse:9000
      - BLACKBOX_REDIS_HOST=redis
    depends_on:
      - clickhouse
      - redis

  # -------------------------------------------------------
  # 3. The HUD (React Frontend)
  # -------------------------------------------------------
  hud:
    build: ../../blackbox-hud
    image: blackbox-hud:latest
    container_name: blackbox-hud
    ports:
      - "3000:80"
    depends_on:
      - tower

  # -------------------------------------------------------
  # 4. The Relay (Enterprise SOAR) - NEW!
  # -------------------------------------------------------
  relay:
    build: ../../blackbox-relay
    image: blackbox-relay:latest
    container_name: blackbox-relay
    restart: always
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Replace this with your real Slack Webhook URL for testing
      # https://api.slack.com/messaging/webhooks
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-""}
    depends_on:
      - redis

  # -------------------------------------------------------
  # 5. The Vacuum (Cloud Aggregator)
  # -------------------------------------------------------
  vacuum:
    build: ../../blackbox-vacuum
    image: blackbox-vacuum:latest
    container_name: blackbox-vacuum
    restart: always
    environment:
      - VACUUM_CORE_HOST=core
      - VACUUM_CORE_PORT=601
      - VACUUM_WEBHOOK_PORT=9090
    depends_on:
      - core

  # -------------------------------------------------------
  # 6. Infrastructure (DB & Cache)
  # -------------------------------------------------------
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: blackbox-db
    ports:
      - "8123:8123"
      - "9000:9000"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./database/clickhouse/schema:/docker-entrypoint-initdb.d

  redis:
    image: redis:7-alpine
    container_name: blackbox-redis
    ports:
      - "6379:6379"

volumes:
  clickhouse_data: